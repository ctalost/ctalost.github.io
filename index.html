<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Space | Premium</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        :root {
            --bg-dark: #1e1f22;
            --bg-panel: #2b2d31;
            --primary: #5865F2;
            --accent: #eb459e;
            --text-main: #ffffff;
            --text-dim: #949ba4;
            --border: #111214;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px; /* Sidebar | Canvas | Chat */
            width: 100%;
            height: 100%;
        }

        /* --- LEFT: TOOLS --- */
        .sidebar {
            background: var(--bg-panel);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-right: 1px solid var(--border);
        }

        .logo {
            font-weight: 800;
            font-size: 1.2rem;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .tool-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 600;
        }

        button {
            background: #383a40;
            border: none;
            color: white;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button:hover { background: #404249; }
        button.active { background: var(--primary); color: white; }
        
        button.danger { color: #ff5555; }
        button.danger:hover { background: rgba(255, 85, 85, 0.1); }

        input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            cursor: pointer;
            background: transparent;
        }

        /* --- CENTER: CANVAS --- */
        .main-stage {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #313338;
            position: relative;
            overflow: hidden;
        }

        /* The wrapper ensures cursors stay relative to the grid */
        .canvas-wrapper {
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border: 4px solid var(--bg-dark);
            border-radius: 8px;
            cursor: crosshair;
        }

        #grid {
            display: grid;
            grid-template-columns: repeat(40, 1fr); /* 40x25 Grid */
            width: 800px;
            height: 500px;
            background: #fff;
        }

        .pixel {
            width: 100%;
            height: 100%;
            background: #ffffff; /* Default white canvas */
            border: 1px solid rgba(0,0,0,0.05); /* Light grid lines */
        }

        /* CURSORS */
        .cursor {
            position: absolute;
            pointer-events: none;
            z-index: 10;
            transition: all 0.1s linear;
        }
        
        .cursor-arrow {
            width: 0; height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid var(--accent);
        }
        
        .cursor-name {
            background: var(--bg-dark);
            color: white;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 4px;
            white-space: nowrap;
            margin-top: 2px;
            margin-left: 6px;
        }

        /* --- RIGHT: CHAT --- */
        .chat-panel {
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        #chat-feed {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .msg { font-size: 0.9rem; line-height: 1.4; word-break: break-word; }
        .msg strong { color: var(--primary); }
        .msg span { color: var(--text-dim); font-size: 0.75rem; margin-left: 5px; }

        .chat-input-box {
            padding: 15px;
            background: #232428;
        }

        #chat-input {
            width: 100%;
            background: #383a40;
            border: none;
            padding: 10px;
            border-radius: 4px;
            color: white;
            outline: none;
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
            .sidebar { flex-direction: row; align-items: center; padding: 10px; overflow-x: auto;}
            .chat-panel { height: 200px; }
            #grid { width: 90vw; height: 56.25vw; } /* Maintain aspect ratio */
        }
    </style>
</head>
<body>

    <div class="app-container">
        
        <nav class="sidebar">
            <div class="logo">Pixel Space</div>
            
            <div class="tool-section">
                <div class="label">User</div>
                <div id="username-display" style="font-weight: bold; font-size: 0.9rem;">Guest</div>
                <div class="label" style="margin-top: 5px;">Online: <span id="online-count">1</span></div>
            </div>

            <div class="tool-section">
                <div class="label">Tools</div>
                <button id="btn-draw" class="active">‚úèÔ∏è Pencil</button>
                <button id="btn-erase">üßº Eraser</button>
            </div>

            <div class="tool-section">
                <div class="label">Palette</div>
                <input type="color" id="color-picker" value="#5865F2">
            </div>

            <div class="tool-section" style="margin-top: auto;">
                <button id="btn-clear" class="danger">üóëÔ∏è Clear Canvas</button>
            </div>
        </nav>

        <main class="main-stage">
            <div class="canvas-wrapper" id="canvas-wrapper">
                <div id="remote-cursor-layer"></div>
                <div id="grid">
                    </div>
            </div>
        </main>

        <aside class="chat-panel">
            <div class="chat-header">
                Live Chat
            </div>
            <div id="chat-feed"></div>
            <div class="chat-input-box">
                <input type="text" id="chat-input" placeholder="Type a message...">
            </div>
        </aside>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, update, push, onValue, onChildAdded, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAE75AlF1oDc_02lue7A7rtZ74x0y3eQLI",
            authDomain: "retrochat-795b4.firebaseapp.com",
            databaseURL: "https://retrochat-795b4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "retrochat-795b4",
            storageBucket: "retrochat-795b4.firebasestorage.app",
            messagingSenderId: "588960494570",
            appId: "1:588960494570:web:702a85c54f386e626fb893",
            measurementId: "G-PLF4ETNC5Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- VARIABLES ---
        const GRID_W = 40;
        const GRID_H = 25;
        const TOTAL_PIXELS = GRID_W * GRID_H;
        
        let currentTool = 'draw';
        let isMouseDown = false;
        const myId = Math.random().toString(36).substr(2, 9);
        const myName = "Artist-" + Math.floor(Math.random() * 100);
        document.getElementById('username-display').innerText = myName;

        // --- DOM ---
        const grid = document.getElementById('grid');
        const wrapper = document.getElementById('canvas-wrapper');
        const colorPicker = document.getElementById('color-picker');
        const chatFeed = document.getElementById('chat-feed');

        // --- 1. INITIALIZE GRID ---
        function initGrid() {
            grid.innerHTML = '';
            for(let i=0; i<TOTAL_PIXELS; i++) {
                const pixel = document.createElement('div');
                pixel.classList.add('pixel');
                pixel.dataset.id = i;
                
                // Add event listeners per pixel for performance
                pixel.addEventListener('mousedown', () => {
                    isMouseDown = true;
                    draw(i);
                });
                pixel.addEventListener('mouseenter', () => {
                    if(isMouseDown) draw(i);
                });

                grid.appendChild(pixel);
            }
        }
        initGrid();

        document.addEventListener('mouseup', () => isMouseDown = false);

        // --- 2. DRAWING LOGIC ---
        function draw(index) {
            let color = colorPicker.value;
            if (currentTool === 'erase') color = '#ffffff'; // Eraser paints white

            // 1. Optimistic UI update (Instant feedback)
            grid.children[index].style.backgroundColor = color;

            // 2. Send to Firebase
            set(ref(db, `pixels/${index}`), color);
        }

        // --- 3. SYNC PIXELS ---
        const pixelsRef = ref(db, 'pixels');
        onValue(pixelsRef, (snapshot) => {
            const data = snapshot.val();
            if(!data) {
                // If board is clear
                Array.from(grid.children).forEach(p => p.style.backgroundColor = '#ffffff');
                return;
            }
            // Update pixels
            Object.keys(data).forEach(key => {
                const idx = parseInt(key);
                if(grid.children[idx]) {
                    grid.children[idx].style.backgroundColor = data[key];
                }
            });
        });

        // --- 4. MULTIPLAYER CURSORS (FIXED) ---
        const cursorRef = ref(db, `cursors/${myId}`);
        onDisconnect(cursorRef).remove(); // Remove my cursor when I leave

        wrapper.addEventListener('mousemove', (e) => {
            // Get position RELATIVE to the canvas wrapper
            const rect = wrapper.getBoundingClientRect();
            
            // Calculate X and Y as percentages (0 to 100)
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            // Simple throttle to prevent lagging the DB
            updateCursor(x, y);
        });

        let lastUpdate = 0;
        function updateCursor(x, y) {
            const now = Date.now();
            if(now - lastUpdate > 50) { // Limit to 20 updates per second
                set(cursorRef, {
                    x: x.toFixed(2), // Round to 2 decimals
                    y: y.toFixed(2),
                    name: myName,
                    color: colorPicker.value
                });
                lastUpdate = now;
            }
        }

        // Render other players' cursors
        onValue(ref(db, 'cursors'), (snapshot) => {
            const cursors = snapshot.val() || {};
            const layer = document.getElementById('remote-cursor-layer');
            
            // Cleanup old cursors
            Array.from(layer.children).forEach(el => {
                if(!cursors[el.id]) el.remove();
            });

            // Update/Add cursors
            Object.keys(cursors).forEach(key => {
                if(key === myId) return; // Don't show my own network cursor

                const data = cursors[key];
                let el = document.getElementById(key);
                
                if(!el) {
                    el = document.createElement('div');
                    el.id = key;
                    el.className = 'cursor';
                    el.innerHTML = `
                        <div class="cursor-arrow" style="border-bottom-color: ${data.color}"></div>
                        <div class="cursor-name">${data.name}</div>
                    `;
                    layer.appendChild(el);
                }
                
                el.style.left = data.x + '%';
                el.style.top = data.y + '%';
            });

            // Update online count
            document.getElementById('online-count').innerText = Object.keys(cursors).length;
        });

        // --- 5. CHAT SYSTEM ---
        const chatInput = document.getElementById('chat-input');
        
        chatInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter' && chatInput.value.trim() !== '') {
                push(ref(db, 'chat'), {
                    name: myName,
                    text: chatInput.value.trim(),
                    ts: Date.now()
                });
                chatInput.value = '';
            }
        });

        onChildAdded(ref(db, 'chat'), (snapshot) => {
            const data = snapshot.val();
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg';
            
            // Format time
            const date = new Date(data.ts);
            const timeStr = date.getHours() + ':' + date.getMinutes().toString().padStart(2, '0');

            msgDiv.innerHTML = `<strong>${data.name}</strong><span>${timeStr}</span><br>${data.text}`;
            
            chatFeed.appendChild(msgDiv);
            chatFeed.scrollTop = chatFeed.scrollHeight; // Auto-scroll
        });

        // --- 6. TOOLS & CONTROLS ---
        document.getElementById('btn-draw').onclick = (e) => setTool('draw', e.target);
        document.getElementById('btn-erase').onclick = (e) => setTool('erase', e.target);
        
        document.getElementById('btn-clear').onclick = () => {
            if(confirm("Are you sure you want to wipe the canvas for everyone?")) {
                remove(ref(db, 'pixels'));
            }
        };

        function setTool(tool, btn) {
            currentTool = tool;
            // Update UI
            document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

    </script>
</body>
</html>
