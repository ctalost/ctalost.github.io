<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArtSync - Multiplayer Canvas</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --bg-dark: #0f0f23;
            --bg-card: #1a1a2e;
            --bg-input: #16213e;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(236, 72, 153, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Login Screen */
        .login-screen {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px;
        }

        .login-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 48px;
            width: 100%; max-width: 480px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo { text-align: center; margin-bottom: 32px; }
        .logo h1 {
            font-size: 3rem; font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo p { color: var(--text-muted); margin-top: 8px; }

        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-muted); }
        .input-group input {
            width: 100%; padding: 16px 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text); font-size: 1rem;
            transition: all 0.3s ease;
        }
        .input-group input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); }

        .btn {
            width: 100%; padding: 16px 32px;
            border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.5); }
        .btn-secondary { background: transparent; border: 2px solid var(--primary); color: var(--primary); margin-top: 12px; }
        .btn-secondary:hover { background: var(--primary); color: white; }

        .divider { display: flex; align-items: center; margin: 24px 0; color: var(--text-muted); }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: rgba(255, 255, 255, 0.1); }
        .divider span { padding: 0 16px; font-size: 0.875rem; }

        /* App Container */
        .app-container { display: none; height: 100vh; }

        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 24px; background: var(--bg-card);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .header-left, .header-right { display: flex; align-items: center; gap: 16px; }
        .header-logo {
            font-size: 1.5rem; font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .room-info { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--bg-input); border-radius: 8px; }
        .room-code { font-family: monospace; font-size: 1rem; color: var(--primary); font-weight: 600; }
        .copy-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; }
        .copy-btn:hover { color: var(--primary); }

        .user-avatar {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.875rem; margin-left: -8px;
            border: 2px solid var(--bg-card); position: relative; cursor: pointer;
        }
        .user-avatar:first-child { margin-left: 0; }
        .user-avatar .tooltip {
            position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%);
            background: var(--bg-dark); padding: 4px 8px; border-radius: 4px;
            font-size: 0.75rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .user-avatar:hover .tooltip { opacity: 1; }

        .leave-btn { padding: 10px 20px; background: var(--danger); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .leave-btn:hover { background: #dc2626; }

        /* Main Content */
        .main-content { display: flex; height: calc(100vh - 73px); }

        /* Toolbar */
        .toolbar {
            width: 72px; background: var(--bg-card); border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 12px; display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .tool-btn {
            width: 48px; height: 48px; border: none; border-radius: 12px;
            background: transparent; color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .tool-btn:hover { background: var(--bg-input); color: var(--text); }
        .tool-btn.active { background: var(--primary); color: white; }
        .tool-btn svg { width: 24px; height: 24px; }
        .tool-divider { width: 32px; height: 1px; background: rgba(255, 255, 255, 0.1); margin: 8px 0; }

        .color-preview {
            width: 40px; height: 40px; border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.2); cursor: pointer; transition: transform 0.2s;
        }
        .color-preview:hover { transform: scale(1.1); }
        #colorPicker { position: absolute; opacity: 0; width: 40px; height: 40px; cursor: pointer; }

        .brush-size-wrapper { margin-top: auto; text-align: center; }
        .brush-size-display { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
        .brush-slider {
            writing-mode: vertical-lr; direction: rtl; width: 6px; height: 120px;
            -webkit-appearance: none; background: var(--bg-input); border-radius: 3px; outline: none;
        }
        .brush-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: var(--primary); cursor: pointer;
        }

        .history-controls { display: flex; gap: 4px; margin-top: auto; padding-top: 8px; }
        .history-btn {
            width: 36px; height: 36px; border: none; border-radius: 8px;
            background: var(--bg-input); color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .history-btn:hover:not(:disabled) { background: var(--primary); color: white; }
        .history-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Canvas Area */
        .canvas-area {
            flex: 1; display: flex; justify-content: center; align-items: center;
            background: var(--bg-input); position: relative; overflow: hidden;
        }
        .canvas-container {
            position: relative; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border-radius: 8px; overflow: hidden;
        }
        #canvas { display: block; background: white; cursor: crosshair; }

        /* Remote Cursors */
        .remote-cursor {
            position: absolute; pointer-events: none; z-index: 100;
            transition: left 0.05s linear, top 0.05s linear;
        }
        .cursor-pointer {
            width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .cursor-name {
            position: absolute; top: 24px; left: 0; background: rgba(0, 0, 0, 0.8);
            color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;
        }

        /* Chat Panel */
        .chat-panel {
            width: 320px; background: var(--bg-card);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; flex-direction: column;
        }
        .chat-header {
            padding: 16px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600; display: flex; align-items: center; gap: 8px;
        }
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;
        }
        .chat-message { display: flex; gap: 10px; }
        .message-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; font-weight: 600; flex-shrink: 0;
        }
        .message-content { flex: 1; }
        .message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .message-name { font-weight: 600; font-size: 0.875rem; }
        .message-time { font-size: 0.75rem; color: var(--text-muted); }
        .message-text { font-size: 0.875rem; color: var(--text); line-height: 1.5; }
        .system-message {
            text-align: center; color: var(--text-muted); font-size: 0.75rem;
            padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;
        }
        .chat-input-wrapper { padding: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .chat-input-container { display: flex; gap: 8px; }
        .chat-input {
            flex: 1; padding: 12px 16px; border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; background: var(--bg-input); color: var(--text);
            font-size: 0.875rem; outline: none; transition: border-color 0.2s;
        }
        .chat-input:focus { border-color: var(--primary); }
        .send-btn {
            width: 44px; height: 44px; border: none; border-radius: 12px;
            background: var(--primary); color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .send-btn:hover { background: var(--primary-dark); }

        /* Toast & Loading */
        .toast-container {
            position: fixed; top: 24px; right: 24px; z-index: 1000;
            display: flex; flex-direction: column; gap: 8px;
        }
        .toast {
            padding: 12px 20px; background: var(--bg-card); border-radius: 12px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.info { border-left: 3px solid var(--primary); }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 15, 35, 0.9); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .loading-spinner {
            width: 48px; height: 48px; border: 4px solid var(--bg-input);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .color-palette {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;
            padding: 8px; background: var(--bg-dark); border-radius: 12px; margin-top: 8px;
        }
        .palette-color {
            width: 24px; height: 24px; border-radius: 4px; cursor: pointer;
            transition: transform 0.2s;
        }
        .palette-color:hover { transform: scale(1.2); }

        @media (max-width: 768px) {
            .chat-panel { display: none; }
            .toolbar { width: 60px; padding: 8px; }
            .tool-btn { width: 40px; height: 40px; }
            .header { padding: 12px 16px; }
            .room-info { display: none; }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="logo">
                <h1>ðŸŽ¨ ArtSync</h1>
                <p>Real-time collaborative canvas</p>
            </div>
            
            <div class="input-group">
                <label for="username">Your Name</label>
                <input type="text" id="username" placeholder="Enter your display name" maxlength="20">
            </div>
            
            <button class="btn btn-primary" id="createRoomBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="16"/>
                    <line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
                Create New Room
            </button>
            
            <div class="divider"><span>or join existing</span></div>
            
            <div class="input-group">
                <label for="roomCode">Room Code</label>
                <input type="text" id="roomCode" placeholder="Enter 6-character room code" maxlength="6" style="text-transform: uppercase;">
            </div>
            
            <button class="btn btn-secondary" id="joinRoomBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                    <polyline points="10 17 15 12 10 7"/>
                    <line x1="15" y1="12" x2="3" y2="12"/>
                </svg>
                Join Room
            </button>
        </div>
    </div>
    
    <div class="app-container" id="appContainer">
        <header class="header">
            <div class="header-left">
                <span class="header-logo">ðŸŽ¨ ArtSync</span>
                <div class="room-info">
                    <span>Room:</span>
                    <span class="room-code" id="displayRoomCode">ABC123</span>
                    <button class="copy-btn" id="copyCodeBtn" title="Copy room code">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="header-right">
                <div class="users-online">
                    <div class="users-avatars" id="usersAvatars"></div>
                </div>
                <button class="leave-btn" id="leaveBtn">Leave Room</button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="toolbar">
                <button class="tool-btn active" data-tool="brush" title="Brush">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    </svg>
                </button>
                <button class="tool-btn" data-tool="eraser" title="Eraser">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 20H7L3 16c-.8-.8-.8-2 0-2.8L13.8 2.4c.8-.8 2-.8 2.8 0L21 6.8c.8.8.8 2 0 2.8L12 18"/>
                    </svg>
                </button>
                <button class="tool-btn" data-tool="fill" title="Fill Bucket">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 11l-8-8-8.6 8.6a2 2 0 0 0 0 2.8l5.2 5.2c.8.8 2 .8 2.8 0L19 11z"/>
                        <path d="M5 2l5 5"/>
                        <path d="M2 13h15"/>
                        <path d="M22 20.7c0 .8-.7 1.3-1.5 1.3s-1.5-.5-1.5-1.3c0-1 1.5-2.7 1.5-2.7s1.5 1.7 1.5 2.7z"/>
                    </svg>
                </button>
                
                <div class="tool-divider"></div>
                
                <button class="tool-btn" data-tool="line" title="Line">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="19" x2="19" y2="5"/>
                    </svg>
                </button>
                <button class="tool-btn" data-tool="rect" title="Rectangle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                    </svg>
                </button>
                <button class="tool-btn" data-tool="circle" title="Circle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="9"/>
                    </svg>
                </button>
                
                <div class="tool-divider"></div>
                
                <div class="color-picker-wrapper">
                    <input type="color" id="colorPicker" value="#6366f1">
                    <div class="color-preview" id="colorPreview" style="background: #6366f1;"></div>
                </div>
                
                <div class="color-palette" id="colorPalette"></div>
                
                <div class="brush-size-wrapper">
                    <div class="brush-size-display"><span id="brushSizeValue">5</span>px</div>
                    <input type="range" class="brush-slider" id="brushSlider" min="1" max="50" value="5">
                </div>
                
                <div class="history-controls">
                    <button class="history-btn" id="undoBtn" title="Undo" disabled>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 7v6h6"/>
                            <path d="M3 13a9 9 0 1 0 3-7.7L3 7"/>
                        </svg>
                    </button>
                    <button class="history-btn" id="redoBtn" title="Redo" disabled>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 7v6h-6"/>
                            <path d="M21 13a9 9 0 1 1-3-7.7L21 7"/>
                        </svg>
                    </button>
                </div>
                
                <button class="tool-btn download-btn" id="downloadBtn" title="Download Canvas">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
                
                <button class="tool-btn" id="clearBtn" title="Clear Canvas" style="color: var(--danger);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
            </div>
            
            <div class="canvas-area" id="canvasArea">
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="canvas" width="1200" height="800"></canvas>
                </div>
            </div>
            
            <div class="chat-panel">
                <div class="chat-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Room Chat
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-wrapper">
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." maxlength="500">
                        <button class="send-btn" id="sendBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script>
        // Firebase Configuration
        // NOTE: If this configuration is invalid/expired, you must replace it with your own Firebase project config.
        const firebaseConfig = {
            apiKey: "AIzaSyAE75AlF1oDc_02lue7A7rtZ74x0y3eQLI",
            authDomain: "retrochat-795b4.firebaseapp.com",
            databaseURL: "https://retrochat-795b4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "retrochat-795b4",
            storageBucket: "retrochat-795b4.firebasestorage.app",
            messagingSenderId: "588960494570",
            appId: "1:588960494570:web:702a85c54f386e626fb893",
            measurementId: "G-PLF4ETNC5Z"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) {
            console.error("Firebase init error:", e);
        }
        
        const database = firebase.database();

        // App State
        const state = {
            username: '',
            userId: '', // Renamed from oderId for clarity
            roomCode: '',
            currentTool: 'brush',
            currentColor: '#6366f1',
            brushSize: 5,
            isDrawing: false,
            lastX: 0,
            lastY: 0,
            shapeStartX: 0,
            shapeStartY: 0,
            users: {},
            undoStack: [],
            redoStack: [],
            maxHistory: 50
        };

        // Color Palette
        const colors = [
            '#000000', '#ffffff', '#ef4444', '#f97316',
            '#eab308', '#22c55e', '#14b8a6', '#3b82f6',
            '#6366f1', '#8b5cf6', '#d946ef', '#ec4899',
            '#78716c', '#64748b', '#0ea5e9', '#84cc16'
        ];

        // DOM Elements
        const elements = {
            loginScreen: document.getElementById('loginScreen'),
            appContainer: document.getElementById('appContainer'),
            username: document.getElementById('username'),
            roomCode: document.getElementById('roomCode'),
            createRoomBtn: document.getElementById('createRoomBtn'),
            joinRoomBtn: document.getElementById('joinRoomBtn'),
            displayRoomCode: document.getElementById('displayRoomCode'),
            copyCodeBtn: document.getElementById('copyCodeBtn'),
            leaveBtn: document.getElementById('leaveBtn'),
            usersAvatars: document.getElementById('usersAvatars'),
            canvas: document.getElementById('canvas'),
            canvasArea: document.getElementById('canvasArea'),
            canvasContainer: document.getElementById('canvasContainer'),
            colorPicker: document.getElementById('colorPicker'),
            colorPreview: document.getElementById('colorPreview'),
            colorPalette: document.getElementById('colorPalette'),
            brushSlider: document.getElementById('brushSlider'),
            brushSizeValue: document.getElementById('brushSizeValue'),
            undoBtn: document.getElementById('undoBtn'),
            redoBtn: document.getElementById('redoBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            clearBtn: document.getElementById('clearBtn'),
            chatMessages: document.getElementById('chatMessages'),
            chatInput: document.getElementById('chatInput'),
            sendBtn: document.getElementById('sendBtn'),
            toastContainer: document.getElementById('toastContainer'),
            loadingOverlay: document.getElementById('loadingOverlay')
        };

        const ctx = elements.canvas.getContext('2d');
        let tempCanvas, tempCtx;

        // Utility Functions
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function getRandomColor() {
            const hue = Math.floor(Math.random() * 360);
            return `hsl(${hue}, 70%, 50%)`;
        }

        function escapeHtml(text) {
             const div = document.createElement('div');
             div.textContent = text;
             return div.innerHTML;
        }

        function showLoading() {
            elements.loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            elements.loadingOverlay.style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            elements.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Initialize Color Palette
        function initColorPalette() {
            colors.forEach(color => {
                const div = document.createElement('div');
                div.className = 'palette-color';
                div.style.background = color;
                div.addEventListener('click', () => setColor(color));
                elements.colorPalette.appendChild(div);
            });
        }

        function setColor(color) {
            state.currentColor = color;
            elements.colorPicker.value = color;
            elements.colorPreview.style.background = color;
            document.querySelectorAll('.palette-color').forEach(el => {
                el.classList.toggle('active', el.style.background === color);
            });
        }

        // Canvas Setup
        function initCanvas() {
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, elements.canvas.width, elements.canvas.height);
            
            // Create temp canvas for shape preview
            tempCanvas = document.createElement('canvas');
            tempCanvas.width = elements.canvas.width;
            tempCanvas.height = elements.canvas.height;
            tempCtx = tempCanvas.getContext('2d');
            
            saveState();
        }

        function saveState() {
            if (state.undoStack.length >= state.maxHistory) {
                state.undoStack.shift();
            }
            state.undoStack.push(elements.canvas.toDataURL());
            state.redoStack = [];
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            elements.undoBtn.disabled = state.undoStack.length <= 1;
            elements.redoBtn.disabled = state.redoStack.length === 0;
        }

        function undo() {
            if (state.undoStack.length <= 1) return;
            state.redoStack.push(state.undoStack.pop());
            loadCanvasState(state.undoStack[state.undoStack.length - 1]);
            updateHistoryButtons();
            syncCanvas();
        }

        function redo() {
            if (state.redoStack.length === 0) return;
            const stateData = state.redoStack.pop();
            state.undoStack.push(stateData);
            loadCanvasState(stateData);
            updateHistoryButtons();
            syncCanvas();
        }

        function loadCanvasState(dataUrl) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = dataUrl;
        }

        // Drawing Functions
        function getCanvasCoords(e) {
            const rect = elements.canvas.getBoundingClientRect();
            const scaleX = elements.canvas.width / rect.width;
            const scaleY = elements.canvas.height / rect.height;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            if(e.type.startsWith('touch')) e.preventDefault();
            
            const {x, y} = getCanvasCoords(e);
            
            state.isDrawing = true;
            state.lastX = x;
            state.lastY = y;
            state.shapeStartX = x;
            state.shapeStartY = y;
            
            if (state.currentTool === 'brush' || state.currentTool === 'eraser') {
                ctx.beginPath();
                ctx.arc(x, y, state.brushSize / 2, 0, Math.PI * 2);
                ctx.fillStyle = state.currentTool === 'eraser' ? 'white' : state.currentColor;
                ctx.fill();
                
                syncStroke({
                    tool: state.currentTool,
                    color: state.currentTool === 'eraser' ? 'white' : state.currentColor,
                    size: state.brushSize,
                    points: [{ x, y }]
                });
            } else if (state.currentTool === 'fill') {
                floodFill(Math.floor(x), Math.floor(y), state.currentColor);
                saveState();
                syncCanvas();
            }
            
            // Copy canvas to temp for shape preview
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempCtx.drawImage(elements.canvas, 0, 0);
        }

        function draw(e) {
            if (!state.isDrawing) return;
            if(e.type.startsWith('touch')) e.preventDefault();

            const {x, y} = getCanvasCoords(e);
            
            // Sync cursor position
            syncCursor(x, y);
            
            if (state.currentTool === 'brush' || state.currentTool === 'eraser') {
                ctx.beginPath();
                ctx.moveTo(state.lastX, state.lastY);
                ctx.lineTo(x, y);
                ctx.strokeStyle = state.currentTool === 'eraser' ? 'white' : state.currentColor;
                ctx.lineWidth = state.brushSize;
                ctx.stroke();
                
                syncStroke({
                    tool: state.currentTool,
                    color: state.currentTool === 'eraser' ? 'white' : state.currentColor,
                    size: state.brushSize,
                    points: [{ x: state.lastX, y: state.lastY }, { x, y }]
                });
                
                state.lastX = x;
                state.lastY = y;
            } else if (['line', 'rect', 'circle'].includes(state.currentTool)) {
                // Clear and redraw base
                ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
                ctx.drawImage(tempCanvas, 0, 0);
                
                ctx.strokeStyle = state.currentColor;
                ctx.lineWidth = state.brushSize;
                ctx.beginPath();
                
                if (state.currentTool === 'line') {
                    ctx.moveTo(state.shapeStartX, state.shapeStartY);
                    ctx.lineTo(x, y);
                } else if (state.currentTool === 'rect') {
                    ctx.rect(state.shapeStartX, state.shapeStartY, x - state.shapeStartX, y - state.shapeStartY);
                } else if (state.currentTool === 'circle') {
                    const radius = Math.sqrt(Math.pow(x - state.shapeStartX, 2) + Math.pow(y - state.shapeStartY, 2));
                    ctx.arc(state.shapeStartX, state.shapeStartY, radius, 0, Math.PI * 2);
                }
                ctx.stroke();
            }
        }

        function stopDrawing(e) {
            if (!state.isDrawing) return;
            state.isDrawing = false;
            
            if (['line', 'rect', 'circle'].includes(state.currentTool)) {
                // Determine end coordinates. For mouseup, use clientX/Y directly. 
                // For touchend, use changedTouches.
                let clientX, clientY;
                
                if (e.changedTouches && e.changedTouches.length > 0) {
                     clientX = e.changedTouches[0].clientX;
                     clientY = e.changedTouches[0].clientY;
                } else {
                     clientX = e.clientX;
                     clientY = e.clientY;
                }

                const rect = elements.canvas.getBoundingClientRect();
                const scaleX = elements.canvas.width / rect.width;
                const scaleY = elements.canvas.height / rect.height;
                const x = (clientX - rect.left) * scaleX;
                const y = (clientY - rect.top) * scaleY;
                
                syncShape({
                    tool: state.currentTool,
                    color: state.currentColor,
                    size: state.brushSize,
                    startX: state.shapeStartX,
                    startY: state.shapeStartY,
                    endX: x,
                    endY: y
                });
            }
            
            saveState();
            syncCanvas();
        }

        // Flood Fill
        function floodFill(startX, startY, fillColor) {
            const imageData = ctx.getImageData(0, 0, elements.canvas.width, elements.canvas.height);
            const data = imageData.data;
            const width = elements.canvas.width;
            const height = elements.canvas.height;
            
            const startIdx = (startY * width + startX) * 4;
            const startR = data[startIdx];
            const startG = data[startIdx + 1];
            const startB = data[startIdx + 2];
            
            // Parse fill color
            const tempDiv = document.createElement('div');
            tempDiv.style.color = fillColor;
            document.body.appendChild(tempDiv);
            const rgb = getComputedStyle(tempDiv).color.match(/\d+/g).map(Number);
            document.body.removeChild(tempDiv);
            
            if (startR === rgb[0] && startG === rgb[1] && startB === rgb[2]) return;
            
            const stack = [[startX, startY]];
            const visited = new Set();
            
            while (stack.length > 0) {
                const [x, y] = stack.pop();
                const key = `${x},${y}`;
                
                if (visited.has(key)) continue;
                if (x < 0 || x >= width || y < 0 || y >= height) continue;
                
                const idx = (y * width + x) * 4;
                if (Math.abs(data[idx] - startR) > 30 || 
                    Math.abs(data[idx + 1] - startG) > 30 || 
                    Math.abs(data[idx + 2] - startB) > 30) continue;
                
                visited.add(key);
                data[idx] = rgb[0];
                data[idx + 1] = rgb[1];
                data[idx + 2] = rgb[2];
                data[idx + 3] = 255;
                
                stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        // Tool Selection
        function selectTool(tool) {
            state.currentTool = tool;
            document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tool === tool);
            });
        }

        // Firebase Sync Functions
        function syncCursor(x, y) {
            if (!state.roomCode) return;
            database.ref(`rooms/${state.roomCode}/cursors/${state.userId}`).set({
                x, y,
                color: state.users[state.userId]?.color || '#6366f1',
                name: state.username
            });
        }

        function syncStroke(strokeData) {
            if (!state.roomCode) return;
            database.ref(`rooms/${state.roomCode}/strokes`).push({
                ...strokeData,
                userId: state.userId,
                timestamp: Date.now()
            });
        }

        function syncShape(shapeData) {
            if (!state.roomCode) return;
            database.ref(`rooms/${state.roomCode}/shapes`).push({
                ...shapeData,
                userId: state.userId,
                timestamp: Date.now()
            });
        }

        function syncCanvas() {
            if (!state.roomCode) return;
            const dataUrl = elements.canvas.toDataURL('image/png', 0.5);
            database.ref(`rooms/${state.roomCode}/canvas`).set({
                data: dataUrl,
                timestamp: Date.now(),
                updatedBy: state.userId
            });
        }

        // Room Functions
        async function createRoom() {
            const username = elements.username.value.trim();
            if (!username) {
                showToast('Please enter your name', 'error');
                return;
            }
            
            showLoading();
            state.username = username;
            state.userId = generateId();
            state.roomCode = generateRoomCode();
            
            const userColor = getRandomColor();
            state.users[state.userId] = { name: username, color: userColor };
            
            try {
                await database.ref(`rooms/${state.roomCode}`).set({
                    createdAt: Date.now(),
                    createdBy: state.userId
                });
                
                await joinRoomInternal();
                hideLoading();
                showToast('Room created successfully! ðŸŽ‰', 'success');
            } catch (error) {
                hideLoading();
                showToast('Failed to create room. Check console.', 'error');
                console.error(error);
            }
        }

        async function joinRoom() {
            const username = elements.username.value.trim();
            const roomCode = elements.roomCode.value.trim().toUpperCase();
            
            if (!username) {
                showToast('Please enter your name', 'error');
                return;
            }
            if (!roomCode || roomCode.length !== 6) {
                showToast('Please enter a valid 6-character room code', 'error');
                return;
            }
            
            showLoading();
            state.username = username;
            state.userId = generateId();
            state.roomCode = roomCode;
            
            try {
                const snapshot = await database.ref(`rooms/${roomCode}`).once('value');
                if (!snapshot.exists()) {
                    hideLoading();
                    showToast('Room not found', 'error');
                    return;
                }
                
                await joinRoomInternal();
                hideLoading();
                showToast('Joined room successfully! ðŸŽ¨', 'success');
            } catch (error) {
                hideLoading();
                showToast('Failed to join room', 'error');
                console.error(error);
            }
        }

        async function joinRoomInternal() {
            const userColor = getRandomColor();
            state.users[state.userId] = { name: state.username, color: userColor };
            
            // Add user to room
            await database.ref(`rooms/${state.roomCode}/users/${state.userId}`).set({
                name: state.username,
                color: userColor,
                joinedAt: Date.now()
            });
            
            // Set up presence
            const userRef = database.ref(`rooms/${state.roomCode}/users/${state.userId}`);
            userRef.onDisconnect().remove();
            
            const cursorRef = database.ref(`rooms/${state.roomCode}/cursors/${state.userId}`);
            cursorRef.onDisconnect().remove();
            
            // Listen for users
            database.ref(`rooms/${state.roomCode}/users`).on('value', snapshot => {
                const users = snapshot.val() || {};
                state.users = users;
                updateUsersDisplay();
            });
            
            // Listen for user joined/left
            database.ref(`rooms/${state.roomCode}/users`).on('child_added', snapshot => {
                const user = snapshot.val();
                if (snapshot.key !== state.userId) {
                    addSystemMessage(`${user.name} joined the room`);
                }
            });
            
            database.ref(`rooms/${state.roomCode}/users`).on('child_removed', snapshot => {
                const user = snapshot.val();
                addSystemMessage(`${user.name} left the room`);
                // Remove their cursor
                const cursorEl = document.querySelector(`[data-cursor-id="${snapshot.key}"]`);
                if (cursorEl) cursorEl.remove();
            });
            
            // Listen for canvas updates
            database.ref(`rooms/${state.roomCode}/canvas`).on('value', snapshot => {
                const canvasData = snapshot.val();
                if (canvasData && canvasData.updatedBy !== state.userId) {
                    loadCanvasState(canvasData.data);
                }
            });
            
            // Listen for strokes
            database.ref(`rooms/${state.roomCode}/strokes`).orderByChild('timestamp').limitToLast(1).on('child_added', snapshot => {
                const stroke = snapshot.val();
                if (stroke.userId !== state.userId) {
                    drawRemoteStroke(stroke);
                }
            });
            
            // Listen for shapes
            database.ref(`rooms/${state.roomCode}/shapes`).orderByChild('timestamp').limitToLast(1).on('child_added', snapshot => {
                const shape = snapshot.val();
                if (shape.userId !== state.userId) {
                    drawRemoteShape(shape);
                }
            });
            
            // Listen for cursors
            database.ref(`rooms/${state.roomCode}/cursors`).on('value', snapshot => {
                const cursors = snapshot.val() || {};
                updateRemoteCursors(cursors);
            });
            
            // Listen for chat
            database.ref(`rooms/${state.roomCode}/chat`).orderByChild('timestamp').limitToLast(50).on('child_added', snapshot => {
                const message = snapshot.val();
                addChatMessage(message);
            });
            
            // Load existing canvas
            const canvasSnapshot = await database.ref(`rooms/${state.roomCode}/canvas`).once('value');
            if (canvasSnapshot.exists()) {
                loadCanvasState(canvasSnapshot.val().data);
            }
            
            // Show app
            elements.loginScreen.style.display = 'none';
            elements.appContainer.style.display = 'block';
            elements.displayRoomCode.textContent = state.roomCode;
            
            initCanvas();
        }

        function drawRemoteStroke(stroke) {
            ctx.strokeStyle = stroke.color;
            ctx.lineWidth = stroke.size;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (stroke.points.length === 1) {
                ctx.beginPath();
                ctx.arc(stroke.points[0].x, stroke.points[0].y, stroke.size / 2, 0, Math.PI * 2);
                ctx.fillStyle = stroke.color;
                ctx.fill();
            } else {
                ctx.beginPath();
                ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
                ctx.lineTo(stroke.points[1].x, stroke.points[1].y);
                ctx.stroke();
            }
        }

        function drawRemoteShape(shape) {
            ctx.strokeStyle = shape.color;
            ctx.lineWidth = shape.size;
            ctx.beginPath();
            
            if (shape.tool === 'line') {
                ctx.moveTo(shape.startX, shape.startY);
                ctx.lineTo(shape.endX, shape.endY);
            } else if (shape.tool === 'rect') {
                ctx.rect(shape.startX, shape.startY, shape.endX - shape.startX, shape.endY - shape.startY);
            } else if (shape.tool === 'circle') {
                const radius = Math.sqrt(Math.pow(shape.endX - shape.startX, 2) + Math.pow(shape.endY - shape.startY, 2));
                ctx.arc(shape.startX, shape.startY, radius, 0, Math.PI * 2);
            }
            ctx.stroke();
        }

        function updateRemoteCursors(cursors) {
            // Remove old cursors
            document.querySelectorAll('.remote-cursor').forEach(el => {
                if (!cursors[el.dataset.cursorId]) {
                    el.remove();
                }
            });
            
            Object.entries(cursors).forEach(([userId, cursor]) => {
                if (userId === state.userId) return;
                
                let cursorEl = document.querySelector(`[data-cursor-id="${userId}"]`);
                
                if (!cursorEl) {
                    cursorEl = document.createElement('div');
                    cursorEl.className = 'remote-cursor';
                    cursorEl.dataset.cursorId = userId;
                    cursorEl.innerHTML = `
                        <div class="cursor-pointer" style="background: ${cursor.color}"></div>
                        <div class="cursor-name">${cursor.name}</div>
                    `;
                    elements.canvasContainer.appendChild(cursorEl);
                }
                
                const rect = elements.canvas.getBoundingClientRect();
                const scaleX = rect.width / elements.canvas.width;
                const scaleY = rect.height / elements.canvas.height;
                
                cursorEl.style.left = `${cursor.x * scaleX}px`;
                cursorEl.style.top = `${cursor.y * scaleY}px`;
            });
        }

        function updateUsersDisplay() {
            elements.usersAvatars.innerHTML = '';
            Object.entries(state.users).forEach(([userId, user]) => {
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.style.background = user.color;
                avatar.innerHTML = `
                    ${user.name.charAt(0).toUpperCase()}
                    <span class="tooltip">${user.name}${userId === state.userId ? ' (You)' : ''}</span>
                `;
                elements.usersAvatars.appendChild(avatar);
            });
        }

        function leaveRoom() {
            if (confirm('Are you sure you want to leave the room?')) {
                database.ref(`rooms/${state.roomCode}/users/${state.userId}`).remove();
                database.ref(`rooms/${state.roomCode}/cursors/${state.userId}`).remove();
                location.reload();
            }
        }

        // Chat Functions
        function sendMessage() {
            const text = elements.chatInput.value.trim();
            if (!text) return;
            
            database.ref(`rooms/${state.roomCode}/chat`).push({
                userId: state.userId,
                name: state.username,
                color: state.users[state.userId]?.color || '#6366f1',
                text,
                timestamp: Date.now()
            });
            
            elements.chatInput.value = '';
        }

        function addChatMessage(message) {
            const div = document.createElement('div');
            div.className = 'chat-message';
            const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            div.innerHTML = `
                <div class="message-avatar" style="background: ${message.color}">${message.name.charAt(0).toUpperCase()}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-name">${escapeHtml(message.name)}${message.userId === state.userId ? ' (You)' : ''}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message.text)}</div>
                </div>
            `;
            elements.chatMessages.appendChild(div);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'system-message';
            div.textContent = text;
            elements.chatMessages.appendChild(div);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        // Event Listeners
        function initEventListeners() {
            // Buttons
            elements.createRoomBtn.onclick = createRoom;
            elements.joinRoomBtn.onclick = joinRoom;
            elements.leaveBtn.onclick = leaveRoom;
            
            elements.copyCodeBtn.onclick = () => {
                navigator.clipboard.writeText(state.roomCode);
                showToast('Room code copied! ', 'success');
            };
            
            elements.undoBtn.onclick = undo;
            elements.redoBtn.onclick = redo;
            
            elements.downloadBtn.onclick = () => {
                const link = document.createElement('a');
                link.download = `artsync-${state.roomCode}-${Date.now()}.png`;
                link.href = elements.canvas.toDataURL();
                link.click();
                showToast('Canvas downloaded!', 'success');
            };
            
            elements.clearBtn.onclick = () => {
                if (confirm('Clear entire canvas?')) {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, elements.canvas.width, elements.canvas.height);
                    saveState();
                    syncCanvas();
                    showToast('Canvas cleared', 'info');
                }
            };
            
            // Tools
            document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentTool = btn.dataset.tool;
                };
            });
            
            // Color
            elements.colorPicker.oninput = e => setColor(e.target.value);
            elements.colorPreview.onclick = () => elements.colorPicker.click();
            
            // Brush Size
            elements.brushSlider.oninput = e => {
                state.brushSize = parseInt(e.target.value);
                elements.brushSizeValue.textContent = state.brushSize;
            };
            
            // Canvas Events
            elements.canvas.addEventListener('mousedown', startDrawing);
            elements.canvas.addEventListener('mousemove', draw);
            elements.canvas.addEventListener('mouseup', stopDrawing);
            elements.canvas.addEventListener('mouseleave', stopDrawing);
            
            // Touch support
            elements.canvas.addEventListener('touchstart', startDrawing, {passive: false});
            elements.canvas.addEventListener('touchmove', draw, {passive: false});
            elements.canvas.addEventListener('touchend', stopDrawing);
            elements.canvas.addEventListener('touchcancel', stopDrawing);
            
            // Chat
            elements.sendBtn.onclick = sendMessage;
            elements.chatInput.onkeypress = e => {
                if (e.key === 'Enter') sendMessage();
            };
            
            // Enter key for login
            elements.username.onkeypress = e => {
                if (e.key === 'Enter') {
                    if (elements.roomCode.value.trim()) {
                        joinRoom();
                    } else {
                        createRoom();
                    }
                }
            };
            elements.roomCode.onkeypress = e => {
                if (e.key === 'Enter') joinRoom();
            };
            
            // Keyboard shortcuts
            document.addEventListener('keydown', e => {
                if (!elements.appContainer.style.display || elements.appContainer.style.display === 'none') return;
                if (document.activeElement === elements.chatInput) return;
                
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z') {
                        e.preventDefault();
                        if (e.shiftKey) redo();
                        else undo();
                    } else if (e.key === 'y') {
                        e.preventDefault();
                        redo();
                    } else if (e.key === 's') {
                        e.preventDefault();
                        elements.downloadBtn.click();
                    }
                } else {
                    switch(e.key.toLowerCase()) {
                        case 'b': document.querySelector('[data-tool="brush"]').click(); break;
                        case 'e': document.querySelector('[data-tool="eraser"]').click(); break;
                        case 'g': document.querySelector('[data-tool="fill"]').click(); break;
                        case 'l': document.querySelector('[data-tool="line"]').click(); break;
                        case 'r': document.querySelector('[data-tool="rect"]').click(); break;
                        case 'c': document.querySelector('[data-tool="circle"]').click(); break;
                        case '[': 
                            state.brushSize = Math.max(1, state.brushSize - 5);
                            elements.brushSlider.value = state.brushSize;
                            elements.brushSizeValue.textContent = state.brushSize;
                            break;
                        case ']': 
                            state.brushSize = Math.min(50, state.brushSize + 5);
                            elements.brushSlider.value = state.brushSize;
                            elements.brushSizeValue.textContent = state.brushSize;
                            break;
                    }
                }
            });
            
            // Window resize - adjust canvas display
            window.addEventListener('resize', () => {
                const container = elements.canvasArea;
                const maxWidth = container.clientWidth - 40;
                const maxHeight = container.clientHeight - 40;
                const scale = Math.min(maxWidth / elements.canvas.width, maxHeight / elements.canvas.height, 1);
                elements.canvas.style.width = (elements.canvas.width * scale) + 'px';
                elements.canvas.style.height = (elements.canvas.height * scale) + 'px';
            });
            
            // Trigger initial resize
            setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            initColorPalette();
            initEventListeners();
            elements.username.focus();
        });
    </script>
</body>
</html>
