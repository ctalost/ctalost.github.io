<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retro Discord Clone</title>
  <style>
    /* --- RESET & VARIABLES --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-dark: #1a1a2e;
      --bg-medium: #16213e;
      --bg-light: #0f3460;
      --accent: #e94560;
      --text-primary: #00ff88;
      --text-secondary: #88ffcc;
      --text-muted: #7a7a8c;
      --border: #2a2a4a;
      --online: #00ff00;
      --away: #ffff00;
      --offline: #666666;
    }

    body {
      font-family: 'Courier New', 'Lucida Console', monospace;
      background: var(--bg-dark);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      font-size: 14px;
      text-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
    }

    /* Scanline effect */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.1) 0px,
        rgba(0, 0, 0, 0.1) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 9999;
    }

    .container { display: flex; height: 100vh; }

    /* --- SERVER LIST --- */
    .server-list {
      width: 72px;
      background: linear-gradient(180deg, #0a0a1a 0%, #1a1a3a 100%);
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      border-right: 2px solid var(--border);
    }

    .server-icon {
      width: 48px; height: 48px;
      background: var(--bg-light);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s;
      border: 2px solid var(--border);
      font-size: 20px;
      box-shadow: 2px 2px 0 #000;
    }

    .server-icon:hover, .server-icon.active {
      border-radius: 16px;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }

    .server-icon.home { margin-bottom: 8px; border-bottom: 2px solid var(--border); padding-bottom: 8px; }

    /* --- SIDEBAR --- */
    .channel-sidebar {
      width: 240px;
      background: linear-gradient(180deg, var(--bg-medium) 0%, #0d1a30 100%);
      display: flex; flex-direction: column;
      border-right: 2px solid var(--border);
    }

    .server-header {
      padding: 16px;
      border-bottom: 2px solid var(--border);
      font-weight: bold; font-size: 16px;
      background: var(--bg-dark);
      text-transform: uppercase; letter-spacing: 2px;
      box-shadow: 0 2px 0 #000;
    }

    .channel-category { padding: 16px 8px 4px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .channel-list { flex: 1; overflow-y: auto; padding: 8px; }
    
    .channel {
      padding: 6px 8px; cursor: pointer;
      display: flex; align-items: center; gap: 8px;
      border: 1px solid transparent; margin: 2px 0; border-radius: 4px;
    }

    .channel:hover { background: var(--bg-light); border: 1px solid var(--border); }
    .channel.active { background: var(--bg-light); color: var(--text-secondary); border: 1px solid var(--accent); box-shadow: 0 0 5px var(--accent); }
    .channel-hash { color: var(--text-muted); }

    .user-panel {
      padding: 12px; background: #0a0a1a;
      border-top: 2px solid var(--border);
      display: flex; align-items: center; gap: 8px;
    }

    .user-avatar {
      width: 32px; height: 32px;
      background: var(--accent);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; border: 2px solid var(--border);
      position: relative;
    }

    .user-info { flex: 1; overflow: hidden; }
    .user-name { font-size: 12px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-tag { font-size: 10px; color: var(--text-muted); }

    /* --- MAIN CHAT --- */
    .main-chat { flex: 1; display: flex; flex-direction: column; background: var(--bg-dark); min-width: 0; }
    
    .chat-header {
      padding: 16px; border-bottom: 2px solid var(--border);
      display: flex; align-items: center; gap: 12px;
      background: var(--bg-medium); box-shadow: 0 2px 0 #000;
    }
    .chat-header-hash { font-size: 24px; color: var(--text-muted); }
    .chat-header-name { font-weight: bold; font-size: 16px; }
    .chat-header-topic { color: var(--text-muted); font-size: 12px; border-left: 2px solid var(--border); padding-left: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .messages-container {
      flex: 1; overflow-y: auto; padding: 16px;
      display: flex; flex-direction: column; gap: 4px;
      scroll-behavior: smooth;
    }

    .message { display: flex; gap: 12px; padding: 8px; border-radius: 4px; animation: messageIn 0.2s ease; }
    .message:hover { background: rgba(255, 255, 255, 0.02); }
    @keyframes messageIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .message-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; border: 2px solid var(--border); flex-shrink: 0;
    }

    .message-content { flex: 1; min-width: 0; }
    .message-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px; }
    .message-author { font-weight: bold; cursor: pointer; }
    .message-timestamp { font-size: 10px; color: var(--text-muted); }
    .message-text { color: #ccddcc; word-wrap: break-word; line-height: 1.4; }
    
    .system-message { color: var(--text-muted); font-style: italic; padding: 8px 0; text-align: center; font-size: 12px; border-bottom: 1px dashed var(--border); margin: 8px 0; }

    /* --- INPUT AREA --- */
    .chat-input-container { padding: 16px; background: var(--bg-medium); border-top: 2px solid var(--border); }
    .chat-input-wrapper {
      display: flex; background: var(--bg-dark);
      border: 2px solid var(--border); border-radius: 4px;
      box-shadow: inset 2px 2px 0 #000;
    }
    .chat-input {
      flex: 1; padding: 12px 16px; background: transparent; border: none;
      color: var(--text-primary); font-family: inherit; font-size: 14px; outline: none;
    }
    .chat-input-buttons { display: flex; padding: 4px; gap: 4px; }
    .input-btn {
      width: 36px; height: 36px; background: var(--bg-light);
      border: 2px solid var(--border); border-radius: 4px;
      color: var(--text-muted); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .input-btn:hover { background: var(--accent); color: white; }

    /* --- MEMBER LIST --- */
    .member-list {
      width: 200px; background: linear-gradient(180deg, var(--bg-medium) 0%, #0d1a30 100%);
      border-left: 2px solid var(--border); overflow-y: auto; display: none; /* Hidden on small screens */
    }
    @media (min-width: 800px) { .member-list { display: block; } }

    .member-category { padding: 16px 16px 8px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
    .member { padding: 6px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .member:hover { background: rgba(255, 255, 255, 0.05); }
    
    .member-avatar {
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; border: 2px solid var(--border); position: relative;
    }
    .status-indicator {
      position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px;
      border-radius: 50%; border: 2px solid var(--bg-medium);
    }
    .status-indicator.online { background: var(--online); }
    .status-indicator.offline { background: var(--offline); }

    /* --- MODAL --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex; align-items: center; justify-content: center; z-index: 10000;
    }
    .modal {
      background: var(--bg-medium); padding: 32px; border-radius: 8px;
      border: 2px solid var(--accent);
      box-shadow: 0 0 20px var(--accent); text-align: center; max-width: 400px;
    }
    .modal input {
      width: 100%; padding: 12px; background: var(--bg-dark);
      border: 2px solid var(--border); color: var(--text-primary);
      font-family: inherit; margin: 16px 0; outline: none;
    }
    .modal button {
      padding: 12px 32px; background: var(--accent); border: 2px solid #ff6b80;
      color: white; font-family: inherit; font-weight: bold; cursor: pointer;
      text-transform: uppercase; letter-spacing: 2px;
    }
    .hidden { display: none !important; }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--bg-light); }
  </style>
</head>
<body>

  <div class="modal-overlay" id="usernameModal">
    <div class="modal">
      <h2>‚ö° RETROCHAT 98 ‚ö°</h2>
      <p style="margin-top: 10px; color: var(--text-muted);">Enter username to initialize uplink.<br>Messages are live.</p>
      <input type="text" id="usernameInput" placeholder="Enter Call Sign..." maxlength="15" autofocus>
      <button id="joinBtn">CONNECT</button>
      <br><br>
      <button id="clearDataBtn" style="font-size: 10px; padding: 5px; background: #333; border: 1px solid #555;">[RESET MEMORY]</button>
    </div>
  </div>

  <div class="container">
    <div class="server-list">
      <div class="server-icon home">üè†</div>
      <div class="server-icon active">üíæ</div>
      <div class="server-icon">üéÆ</div>
      <div class="server-icon">üéµ</div>
    </div>

    <div class="channel-sidebar">
      <div class="server-header">üìü RetroChat</div>
      <div class="channel-list">
        <div class="channel-category">üìÅ Text Channels</div>
        <div class="channel active" onclick="switchChannel('general')">
          <span class="channel-hash">#</span><span>general</span>
        </div>
        <div class="channel" onclick="switchChannel('random')">
          <span class="channel-hash">#</span><span>random</span>
        </div>
        <div class="channel" onclick="switchChannel('tech')">
          <span class="channel-hash">#</span><span>tech</span>
        </div>
        <div class="channel-category">üîä Voice Channels</div>
        <div class="channel" onclick="switchChannel('lounge')">
          <span class="channel-hash">üîà</span><span>Lounge</span>
        </div>
      </div>
      <div class="user-panel">
        <div class="user-avatar" id="userAvatarSmall">?</div>
        <div class="user-info">
          <div class="user-name" id="userNameDisplay">Guest</div>
          <div class="user-tag">#<span id="userTagDisplay">0000</span></div>
        </div>
        <div class="input-btn">‚öôÔ∏è</div>
      </div>
    </div>

    <div class="main-chat">
      <div class="chat-header">
        <span class="chat-header-hash">#</span>
        <span class="chat-header-name" id="currentChannelName">general</span>
        <span class="chat-header-topic">Welcome to the digital frontier.</span>
      </div>
      <div class="messages-container" id="messagesContainer"></div>
      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <input type="text" class="chat-input" id="messageInput" placeholder="Message #general" autocomplete="off" disabled>
          <div class="chat-input-buttons">
            <div class="input-btn">üòä</div>
            <div class="input-btn">üìé</div>
          </div>
        </div>
      </div>
    </div>

    <div class="member-list">
      <div class="member-category">üü¢ Online ‚Äî <span id="onlineCount">1</span></div>
      <div id="onlineMembers"></div>
      <div class="member-category">‚ö´ Offline ‚Äî <span id="offlineCount">0</span></div>
      <div id="offlineMembers"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, onDisconnect, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- YOUR SPECIFIC FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAE75AlF1oDc_02lue7A7rtZ74x0y3eQLI",
      authDomain: "retrochat-795b4.firebaseapp.com",
      databaseURL: "https://retrochat-795b4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "retrochat-795b4",
      storageBucket: "retrochat-795b4.firebasestorage.app",
      messagingSenderId: "588960494570",
      appId: "1:588960494570:web:702a85c54f386e626fb893"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- CONFIG & STATE ---
    const COLORS = ['#e94560', '#00ff88', '#ffcc00', '#00ccff', '#ff66cc'];
    const EMOJIS = ['üòé', 'ü§ñ', 'üëæ', 'üéÆ', 'üíÄ', 'üî•', 'üíª', 'üìÄ'];
     
    let state = {
      user: null,
      channel: 'general',
      userRef: null,
      lastMsgCount: 0 // Tracks number of messages for sound logic
    };

    // --- DOM ELEMENTS ---
    const els = {
      modal: document.getElementById('usernameModal'),
      input: document.getElementById('usernameInput'),
      joinBtn: document.getElementById('joinBtn'),
      clearBtn: document.getElementById('clearDataBtn'),
      msgContainer: document.getElementById('messagesContainer'),
      msgInput: document.getElementById('messageInput'),
      channelName: document.getElementById('currentChannelName'),
      onlineList: document.getElementById('onlineMembers'),
      offlineList: document.getElementById('offlineMembers'),
      userName: document.getElementById('userNameDisplay'),
      userTag: document.getElementById('userTagDisplay'),
      userAvatar: document.getElementById('userAvatarSmall'),
      channels: document.querySelectorAll('.channel')
    };

    // --- SOUND ENGINE ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playRetroBeep() {
      // Only play if browser allows audio context
      if (audioCtx.state === 'suspended') audioCtx.resume();
      
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      oscillator.type = 'square'; // 8-bit sound wave
      oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4 note
      oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1); // Slide up
      
      gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime); // Low volume
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
      
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.1);
    }

    // --- CORE LOGIC ---
    function init() {
      const savedUser = sessionStorage.getItem('retrochat_session');
      if (savedUser) {
        state.user = JSON.parse(savedUser);
        loginSuccess();
      }
    }

    function loginSuccess() {
      els.modal.classList.add('hidden');
      els.msgInput.disabled = false;
      els.msgInput.focus();
      els.userName.textContent = state.user.name;
      els.userTag.textContent = state.user.tag;
      els.userAvatar.textContent = state.user.emoji;
      els.userAvatar.style.background = state.user.color;
      
      setupRealtimeListeners();
      setupPresence();
    }

    function joinChat() {
      const name = els.input.value.trim();
      if (!name) return;

      const user = {
        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
        name: name,
        tag: Math.floor(Math.random() * 9000 + 1000),
        color: COLORS[Math.floor(Math.random() * COLORS.length)],
        emoji: EMOJIS[Math.floor(Math.random() * EMOJIS.length)],
      };

      state.user = user;
      sessionStorage.setItem('retrochat_session', JSON.stringify(user));
      loginSuccess();
      
      // Resume audio context on user interaction
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    // --- FIREBASE: PRESENCE ---
    function setupPresence() {
      const onlineRef = ref(db, 'online/' + state.user.id);
      state.userRef = onlineRef;

      onDisconnect(onlineRef).remove();

      set(onlineRef, {
        ...state.user,
        lastSeen: serverTimestamp()
      });

      const allUsersRef = ref(db, 'online');
      onValue(allUsersRef, (snapshot) => {
        const data = snapshot.val() || {};
        const users = Object.values(data);
        renderMembers(users);
      });
    }

    // --- FIREBASE: MESSAGING ---
    function setupRealtimeListeners() {
      const messagesRef = ref(db, `messages/${state.channel}`);
      
      // Reset count when switching channels so we don't beep at old history
      state.lastMsgCount = 0;

      onValue(messagesRef, (snapshot) => {
        const data = snapshot.val();
        const msgs = data ? Object.values(data) : [];
        
        // Play sound if we have MORE messages than before, 
        // and it's not the very first load (count > 0)
        if (msgs.length > state.lastMsgCount && state.lastMsgCount !== 0) {
          // Optional: Don't beep if I sent the message
          const lastMsg = msgs[msgs.length - 1];
          if (lastMsg.user.name !== state.user.name) {
               playRetroBeep();
          }
        }

        state.lastMsgCount = msgs.length;
        renderMessages(msgs);
      });
    }

    function sendMessage() {
      const text = els.msgInput.value.trim();
      if (!text || !state.user) return;

      const msg = {
        text: text,
        user: state.user,
        timestamp: Date.now(),
        type: 'user'
      };

      const messagesRef = ref(db, `messages/${state.channel}`);
      push(messagesRef, msg);

      els.msgInput.value = '';
    }

    // --- RENDERING ---
    function renderMessages(messages) {
      els.msgContainer.innerHTML = '';
      
      const welcome = document.createElement('div');
      welcome.className = 'system-message';
      welcome.innerHTML = `Welcome to the start of #${state.channel}`;
      els.msgContainer.appendChild(welcome);

      const recentMessages = messages.slice(-50);

      recentMessages.forEach(msg => {
        const div = document.createElement('div');
        
        if (msg.type === 'system') {
          div.className = 'system-message';
          div.innerHTML = `<span>${msg.text}</span>`;
        } else {
          // --- TEXT FORMATTING LOGIC ---
          let content = escapeHtml(msg.text);
          
          // 1. Linkify URLs
          content = content.replace(
            /(https?:\/\/[^\s]+)/g, 
            '<a href="$1" target="_blank" style="color:#00ff88;text-decoration:underline;">$1</a>'
          );

          // 2. Bold (**text**)
          content = content.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

          // 3. Italic (*text*)
          content = content.replace(/\*(.*?)\*/g, '<i>$1</i>');

          // 4. Code (`text`)
          content = content.replace(
            /`(.*?)`/g, 
            '<code style="background:rgba(255,255,255,0.1);padding:2px 4px;border-radius:3px;font-family:monospace;">$1</code>'
          );

          div.className = 'message';
          div.innerHTML = `
            <div class="message-avatar" style="background:${msg.user.color}">${msg.user.emoji}</div>
            <div class="message-content">
              <div class="message-header">
                <span class="message-author" style="color:${msg.user.color}">${msg.user.name}</span>
                <span class="message-timestamp">${new Date(msg.timestamp).toLocaleTimeString()}</span>
              </div>
              <div class="message-text">${content}</div>
            </div>
          `;
        }
        els.msgContainer.appendChild(div);
      });
      
      // Auto-scroll to bottom
      els.msgContainer.scrollTop = els.msgContainer.scrollHeight;
    }

    function renderMembers(users) {
      document.getElementById('onlineCount').textContent = users.length;
      document.getElementById('offlineCount').textContent = 0;

      const createMemberHTML = (u) => `
        <div class="member">
          <div class="member-avatar" style="background:${u.color}">
            ${u.emoji}
            <div class="status-indicator online"></div>
          </div>
          <span class="member-name" style="color:${u.color}">${u.name}</span>
        </div>
      `;

      els.onlineList.innerHTML = users.map(u => createMemberHTML(u)).join('');
      els.offlineList.innerHTML = '<div style="padding:10px; color:#666; font-size:10px;">Offline history disabled</div>';
    }

    // --- UTILS ---
    window.switchChannel = (channelName) => {
      state.channel = channelName;
      els.channelName.textContent = channelName;
      els.msgInput.placeholder = `Message #${channelName}`;
      
      els.channels.forEach(ch => {
        ch.classList.toggle('active', ch.textContent.includes(channelName));
      });
      
      setupRealtimeListeners(); 
    };

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // --- EVENT LISTENERS ---
    els.joinBtn.addEventListener('click', joinChat);
    els.input.addEventListener('keypress', (e) => e.key === 'Enter' && joinChat());
    els.msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    els.clearBtn.addEventListener('click', () => {
      sessionStorage.clear();
      location.reload();
    });

    init();
  </script>
</body>
</html>
